name: Daily Hi to Claude

on:
  schedule:
    # å¹³æ—¥ JST 17:00 = UTC 08:00 (æœˆã€œé‡‘: 1-5)
    - cron: "0 8 * * 1-5"
    # ä¼‘æ—¥ JST 9:17 = UTC 00:17 (åœŸæ—¥: 0,6) â€»é…å»¶å¯¾ç­–ã§åˆ†ãšã‚‰ã—+å‰å€’ã—
    - cron: "17 0 * * 0,6"
    # ä¼‘æ—¥ JST 15:00 = UTC 06:00 (åœŸæ—¥: 0,6)
    - cron: "0 6 * * 0,6"
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write

jobs:
  say-hi:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Check Claude Code version
        run: claude --version

      - name: Check authentication
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "Token is set: $([ -n "$CLAUDE_CODE_OAUTH_TOKEN" ] && echo 'Yes' || echo 'No')"

      - name: Say hi to Claude
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "hi" | claude --print --output-format json --model haiku --tools "" > response.json
          cat response.json

      - name: Parse response and create summary
        run: |
          # JSONã‹ã‚‰ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
          RESULT=$(jq -r '.result' response.json)
          COST=$(jq -r '.total_cost_usd' response.json)
          INPUT_TOKENS=$(jq -r '.usage.input_tokens' response.json)
          OUTPUT_TOKENS=$(jq -r '.usage.output_tokens' response.json)
          CACHE_CREATION=$(jq -r '.usage.cache_creation_input_tokens' response.json)
          CACHE_READ=$(jq -r '.usage.cache_read_input_tokens' response.json)

          # Summaryã«è¡¨ç¤º
          echo "## ðŸ¤– Claude ã®å¿œç­”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$RESULT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Input Tokens | $INPUT_TOKENS |" >> $GITHUB_STEP_SUMMARY
          echo "| Output Tokens | $OUTPUT_TOKENS |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Creation | $CACHE_CREATION |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Read | $CACHE_READ |" >> $GITHUB_STEP_SUMMARY
          echo "| **ã‚³ã‚¹ãƒˆ (USD)** | **\$$COST** |" >> $GITHUB_STEP_SUMMARY

      - name: Update last run and commit
        run: |
          echo "$(date -u '+%Y-%m-%dT%H:%M:%SZ')" > .github/.last-run
          git config user.name github-actions
          git config user.email action@github.com
          git add .github/.last-run
          git commit -m "Update last run"
          git push
