name: Daily Hi to Claude

on:
  schedule:
    # æ—¥æœ¬æ™‚é–“ 17:00 = UTC 08:00
    - cron: '0 8 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write

jobs:
  say-hi:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Say hi to Claude
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          RESPONSE=$(echo "hi" | claude --print --output-format json --model haiku --allowedTools "")
          echo "$RESPONSE"

          # JSONã‹ã‚‰ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
          RESULT=$(echo "$RESPONSE" | jq -r '.result')
          COST=$(echo "$RESPONSE" | jq -r '.total_cost_usd')
          INPUT_TOKENS=$(echo "$RESPONSE" | jq -r '.usage.input_tokens')
          OUTPUT_TOKENS=$(echo "$RESPONSE" | jq -r '.usage.output_tokens')
          CACHE_CREATION=$(echo "$RESPONSE" | jq -r '.usage.cache_creation_input_tokens')
          CACHE_READ=$(echo "$RESPONSE" | jq -r '.usage.cache_read_input_tokens')

          # Summaryã«è¡¨ç¤º
          echo "## ðŸ¤– Claude ã®å¿œç­”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$RESULT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Input Tokens | $INPUT_TOKENS |" >> $GITHUB_STEP_SUMMARY
          echo "| Output Tokens | $OUTPUT_TOKENS |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Creation | $CACHE_CREATION |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Read | $CACHE_READ |" >> $GITHUB_STEP_SUMMARY
          echo "| **ã‚³ã‚¹ãƒˆ (USD)** | **\$$COST** |" >> $GITHUB_STEP_SUMMARY

      - name: Update last run and commit
        run: |
          echo "$(date -u '+%Y-%m-%dT%H:%M:%SZ')" > .github/.last-run
          git config user.name github-actions
          git config user.email action@github.com
          git add .github/.last-run
          git commit -m "Update last run"
          git push
